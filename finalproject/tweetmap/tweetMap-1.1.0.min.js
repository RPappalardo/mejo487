/*global window:true, jQuery:true, $:true, console:true, google:true *//*
*	jQuery Tweet To Map
*
*	@url		http://tweettomap.com/
*	@author		Simon Betton
*	@version	1.1.0
*/(function(e,t){"use strict";function n(e){e=e.replace(/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/gi,function(e){var t=e;t.match("^https?://")||(t="http://"+t);return'<a href="'+t+'" target="_blank">'+e+"</a>"});return e}function r(e,t,n,r,i,s){google.maps.OverlayView.apply(this,arguments);this.position=e;this.content=t;this.width=n||260;this.height=r||260;this.shadowImg=i||"";this.shadowHeight=s||100;this.loaded=!1}function d(t,n,r){this.element=t;this.options=e.extend({},h,n);this.twitterOptions={q:this.options.q,geocode:this.options.geocode,result_type:this.options.result_type,rpp:this.options.rpp,until:this.options.until,since_id:this.options.since_id,max_id:this.options.max_id,include_entities:this.options.include_entities};this.mapElem=e(this.element)[0];this.mapType=a(this.options.maptype);this.mapOptions={zoom:this.options.zoom,center:new google.maps.LatLng(this.options.latitude,this.options.longitude),mapTypeId:this.mapType};this.refresh();this.init()}r.prototype=new google.maps.OverlayView;r.prototype.constructor=r;r.prototype.onAdd=function(){this.container=e('<div class="gmap-bubble"></div>');this.getPanes().floatPane.appendChild(this.container[0]);if(this.shadowImg){this.shadow=e('<div class="shadow"></div>');this.shadow.css("position","absolute");this.getPanes().floatShadow.appendChild(this.shadow[0])}this.container.css("position","absolute");this.container.height(this.height);this.container.width(this.width);this.container.append('<div class="loading"></div>');this.contentContainer=e('<div class="panel"></div>');this.container.append(this.contentContainer);this.container.append('<div class="pointer">â–²</div><div class="close"><a href="#">x</a></div>');var t=this,n=function(e){e.preventDefault();t.setMap(null)};e(".close > a",this.container).click(n)};r.prototype.draw=function(){this.loaded||this.contentContainer.append(this.content);e(".timeago",this.container).timeago();var t=this.getPoint();this.container.css("left",t.x-30+"px");this.container.css("top",t.y+14+"px");if(this.shadow){this.shadow.css("left",t.x-18+"px");this.shadow.css("top",t.y-this.shadowHeight-8+"px")}if(!this.loaded){this.panMap();this.loaded=!0}};r.prototype.show=function(){this.container.css("visibility","visible")};r.prototype.hide=function(){this.container.css("visibility","hidden")};r.prototype.onRemove=function(){this.contentContainer.remove();this.contentContainer=null;this.container.remove();this.container=null};r.prototype.panMap=function(){var e=this.getPoint();this.getMap().panTo(this.getProjection().fromDivPixelToLatLng(new google.maps.Point(e.x+this.width/2,e.y-this.height/2+200)))};r.prototype.getPoint=function(){return this.getProjection().fromLatLngToDivPixel(this.position)};var i=function(t){if(!t||!t.q)return!1;var n=[];e.each(t,function(e,t){if(t){t=t.replace(/\s*/g,"");var r=e+"="+encodeURIComponent(t);n.push(r)}});return"tweetmap/_proxy/twitter_proxy.php?"+n.join("&")+"&callback=?"},s=function(t,i,s,o){e(o).append('<div class="mapLoading">Loading Tweets...</div>');var u=[];e.getJSON(t,function(t){if(t.results.length===0){console.error&&console.error("We have no location data");return!1}e.each(t.results,function(t,o){if(o.geo){var a=new google.maps.LatLng(o.geo.coordinates[0],o.geo.coordinates[1]),f=new google.maps.MarkerImage(i.marker,null,null,null,new google.maps.Size(50,50)),l=new google.maps.Marker({icon:f,position:a,map:s,optimized:!1}),c="",h="",p;o.entities.media&&o.entities.media[0].media_url_https&&(c='<img src="'+o.entities.media[0].media_url_https+':small" class="tweetImage" />');o.text&&(h=n(o.text));p=function(t){e(".gmap-bubble").remove();var n=new r(a,c+'<span class="tweetText">'+h+'</span><span class="tweetTime timeago" title="'+o.created_at+'"></span>',i.windowwidth,i.windowheight);n.setMap(l.getMap())};u.push(l);google.maps.event.addListener(l,"click",p)}});e(".mapLoading",o).remove();e(o).trigger("markersLoaded");return u});return u},o=function(t,n){t.customMarkers&&e.each(t.customMarkers,function(i,s){var o=new google.maps.LatLng(s.latitude,s.longitude),u=new google.maps.MarkerImage(t.marker,null,null,null,new google.maps.Size(50,50)),a=new google.maps.Marker({icon:u,position:o,map:n,optimized:!1}),f;f=function(n){e(".gmap-bubble").remove();var i=new r(o,s.html,t.windowwidth,t.windowheight);i.setMap(a.getMap())};google.maps.event.addListener(a,"click",f)})},u=function(e){if(e.feed){var t=e.feed;for(var n=0;n<t.length;n+=1){t[n].setMap(null);n===t.length-1&&f(e)}}},a=function(e){switch(e){case"ROADMAP":return google.maps.MapTypeId.ROADMAP;case"SATELLITE":return google.maps.MapTypeId.SATELLITE;case"HYBRID":return google.maps.MapTypeId.HYBRID;case"TERRAIN":return google.maps.MapTypeId.TERRAIN;default:return google.maps.MapTypeId.ROADMAP}},f=function(e){e.url=i(e.twitterOptions);e.feed=s(e.url,e.options,e.map,e.mapElem);p(e.options.customMarkers)||o(e.options,e.map);console.log&&console.log(e.url)},l="tweetMap",c=t.document,h={latitude:"",longitude:"",zoom:11,marker:"tweetmap/marker.png",maptype:"ROADMAP",windowheight:"",windowwidth:"",q:"",geocode:"",result_type:"recent",rpp:"100",until:"",since_id:"",max_id:"",include_entities:"true",customMarkers:{}},p=function(e){return Object.keys(e).length===0};d.prototype.refresh=function(){var t=e(this).data("plugin_"+l);t&&u(t)};d.prototype.init=function(){var e=this;this.map=new google.maps.Map(this.mapElem,this.mapOptions);google.maps.event.addListenerOnce(this.map,"idle",function(t){f(e)})};e.fn[l]=function(t){return this.each(function(){var n=e(this).data("plugin_"+l);e.data(this,"plugin_"+l)||e.data(this,"plugin_"+l,new d(this,t));typeof t=="string"&&n[t].call(this)})}})(jQuery,window);